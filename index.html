<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Harry BI</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body { font-family: Inter, system-ui, sans-serif; margin: 0; background: #0f1115; color: #f6f7fb; }
      .wrap { display: grid; grid-template-columns: 320px 1fr; min-height: 100vh; }
      aside { padding: 16px; border-right: 1px solid #222833; background: #141923; }
      main { padding: 16px; }
      h1,h2,h3 { margin: 0 0 12px; }
      .card { background: #171d29; border: 1px solid #2a3242; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
      label { font-size: 13px; opacity: .9; display: block; margin: 8px 0 4px; }
      input,select,button { width: 100%; box-sizing: border-box; padding: 8px 10px; border-radius: 8px; border: 1px solid #323c52; background: #0f1420; color: #f6f7fb; }
      button { cursor: pointer; background: #3a6ef7; border: none; font-weight: 600; }
      button.secondary { background: #27324a; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      .top { display:grid; grid-template-columns: 1fr; gap: 12px; }
      table { width:100%; border-collapse: collapse; font-size: 13px; }
      th,td { border-bottom: 1px solid #2a3242; padding: 8px; text-align:left; }
      .chip { display:inline-block; padding:4px 8px; background:#24324d; border-radius:999px; margin: 0 6px 6px 0; font-size:12px; }
      .muted { opacity: .75; font-size: 13px; }
      #chartWrap, #chartWrap2 { height: 260px; max-height: 260px; overflow: hidden; position: relative; }
      .tiny { font-size: 12px; opacity: .75; }
      .pager { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
      .pager button { width: auto; padding: 6px 10px; }
      .viewbar { display:flex; gap:8px; margin-bottom:12px; }
      .viewbar button.active { background:#4b7cff; }
      .hidden { display:none !important; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <aside>
        <h2>Harry BI</h2>
        <p class="muted">Low-click CSV analytics</p>

        <div class="card">
          <label>Upload CSV</label>
          <input id="csvFile" type="file" accept=".csv" />
        </div>

        <div class="card">
          <h3>SQL Star Schema</h3>
          <label>Connection type</label>
          <select id="connType">
            <option value="sqlite">SQLite</option>
            <option value="azure">Azure SQL</option>
          </select>

          <div id="sqliteFields">
            <label>SQLite DB path</label>
            <input id="dbPath" placeholder="/abs/path/to/star_demo.db" />
          </div>

          <div id="azureFields" style="display:none;">
            <label>Server</label><input id="azServer" placeholder="yourserver.database.windows.net" />
            <label>Database</label><input id="azDatabase" />
            <label>User</label><input id="azUser" />
            <label>Password</label><input id="azPassword" type="password" />
          </div>

          <div id="connDetails">
            <label>API base URL (optional)</label>
          <input id="apiBase" placeholder="auto: current host on :8787" />
          <button id="connectDbBtn" class="secondary">Connect DB</button>
          </div>
          <button id="toggleConnBtn" class="secondary hidden" style="margin-top:8px;">Edit connection</button>
          <div id="dbStatus" class="tiny" style="margin-top:6px;">Not connected.</div>
        </div>

        <div class="card">
          <h3>Quick transform</h3>
          <label>One-click actions</label>
          <div class="row">
            <button id="presetTrimBtn" class="secondary">Trim spaces</button>
            <button id="undoTransformBtn" class="secondary">Undo last</button>
          </div>
          <div style="height:8px"></div>
          <button id="optimizeTypesBtn" class="secondary">Auto-detect number columns</button>
          <label style="margin-top:10px;">Action</label>
          <select id="actionType">
            <option value="rename">Rename column</option>
            <option value="astype">Set datatype</option>
            <option value="filter_eq">Filter equals</option>
            <option value="filter_range">Filter range</option>
            <option value="sort">Sort</option>
            <option value="drop_columns">Drop columns</option>
            <option value="derived_math">Derived math</option>
          </select>
          <div id="actionForm"></div>
          <button id="addTransformBtn">Add transform</button>
          <div style="height:8px"></div>
          <button id="clearTransformsBtn" class="secondary">Clear all</button>
        </div>

        <div class="card">
          <h3>Applied</h3>
          <div id="appliedList" class="muted">None yet.</div>
        </div>
      </aside>

      <main>
        <div class="viewbar">
          <button id="viewTransformBtn" class="active">Transform</button>
          <button id="viewVisualBtn" class="secondary">Visualize</button>
          <button id="viewDwBtn" class="secondary">DW Mode</button>
        </div>
        <div class="top">
          <div id="modelSection" class="card">
            <h3>Model</h3>
            <div id="starSummary" class="tiny">No star schema loaded.</div>
            <label>Fact table</label><select id="factTable"></select>
            <label>Dimension table</label><select id="dimTable"></select>
            <label>Dimension label column</label><select id="dimLabelCol"></select>
            <label>Measure column (from fact)</label><select id="factMeasureCol"></select>
            <label>Aggregation</label><select id="dbAgg"><option>SUM</option><option>AVG</option><option>COUNT</option><option>MAX</option><option>MIN</option></select>
            <label>Saved report name</label><input id="reportName" placeholder="e.g. Sales by region" />
            <div class="row">
              <button id="saveReportBtn" class="secondary">Save report</button>
              <button id="deleteReportBtn" class="secondary">Delete report</button>
            </div>
            <label>Load saved report</label><select id="savedReportSelect"></select>
            <div class="row">
              <button id="loadReportBtn" class="secondary">Load report</button>
              <button id="autoDbReportBtn" class="secondary">Auto DB report</button>
            </div>
            <button id="runDbReportBtn">Run DB report</button>
          </div>
          <div id="transformSection" class="card">
            <h3>Table</h3>
            <label>Quick search</label>
            <input id="searchInput" placeholder="Type to filter table..." />
            <div id="tableMeta" class="tiny" style="margin-top:6px;">Rows: 0</div>
            <div style="max-height: 60vh; overflow:auto; margin-top:8px;">
              <table id="dataTable"></table>
            </div>
            <div class="pager">
              <button id="prevPageBtn" class="secondary">Prev</button>
              <span id="pageInfo" class="tiny">Page 1</span>
              <button id="nextPageBtn" class="secondary">Next</button>
            </div>
          </div>

          <div id="dwSection" class="card hidden">
            <h3>DW Mode (stg â†’ dim)</h3>
            <p class="tiny">Step 1: build <b>dim.v_&lt;name&gt;</b> from stg. Step 2: choose BKs and create <b>dim.&lt;name&gt;</b>.</p>

            <label>Dimension base name</label><input id="dwDimName" placeholder="customer" />
            <label>Source stg table</label><select id="dwSourceTable"></select>
            <button id="dwLoadColumnsBtn" class="secondary">Load source columns</button>

            <label style="margin-top:10px;">Filter (optional SQL expression)</label>
            <input id="dwWhere" placeholder="is_deleted = 0" />

            <label style="margin-top:10px;">Column mapping (select + rename)</label>
            <div class="row" style="margin-bottom:8px;">
              <button id="dwSelectAllColsBtn" class="secondary">Select all</button>
              <button id="dwDeselectAllColsBtn" class="secondary">Deselect all</button>
            </div>
            <div id="dwColumnsGrid" style="max-height:220px;overflow:auto;border:1px solid #323c52;border-radius:8px;padding:8px;"></div>

            <div class="row" style="margin-top:10px;">
              <button id="dwPreviewBtn" class="secondary">Preview view data</button>
              <button id="dwCreateViewBtn">1) Create/Update view</button>
            </div>
            <div class="row" style="margin-top:8px;">
              <button id="dwRefreshBksBtn" class="secondary">Refresh BK choices</button>
              <button id="dwValidateBksBtn" class="secondary">Validate BKs</button>
            </div>
            <div id="dwPreviewMeta" class="tiny" style="margin-top:6px;"></div>

            <label style="margin-top:10px;">Business keys (click to select)</label>
            <div id="dwBkPicker" style="max-height:140px;overflow:auto;border:1px solid #323c52;border-radius:8px;padding:8px;"></div>

            <button id="dwCreateDimBtn" style="margin-top:10px;">2) Create dimension from view</button>
            <div id="dwStatus" class="tiny" style="margin-top:6px;">DW idle.</div>
          </div>

          <div id="visualSection" class="card hidden">
            <h3>Visual</h3>
            <div class="row">
              <button id="autoVisualBtn" class="secondary">Auto visual suggestion</button>
              <button id="clearChartFilterBtn" class="secondary">Clear chart filter</button>
            </div>
            <div class="row">
              <div>
                <label>X</label><select id="xCol"></select>
              </div>
              <div>
                <label>Y</label><select id="yCol"></select>
              </div>
            </div>
            <div class="row">
              <div>
                <label>Agg</label>
                <select id="aggType">
                  <option>sum</option><option>mean</option><option>count</option><option>max</option><option>min</option>
                </select>
              </div>
              <div>
                <label>Chart</label>
                <select id="chartType"><option>bar</option><option>line</option><option>scatter</option></select>
              </div>
            </div>
            <label>Max points</label>
            <input id="maxPoints" type="number" value="50" min="10" max="500" step="10" />
            <label>Secondary chart</label>
            <select id="chartType2"><option>line</option><option>bar</option><option>scatter</option></select>
            <div id="chartWrap"><canvas id="chart"></canvas></div>
            <div id="chartWrap2" style="margin-top:8px;"><canvas id="chart2"></canvas></div>
          </div>
        </div>
      </main>
    </div>

    <script type="module" src="./src/main.js"></script>
  </body>
</html>
